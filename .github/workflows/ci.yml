name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  GODOT_VERSION: 4.2.2
  EXPORT_NAME: ashes-to-empire

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    container:
      image: barichello/godot-ci:4.2.2
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Cache Godot files
        uses: actions/cache@v3
        with:
          path: |
            .godot/
            .import/
          key: ${{ runner.os }}-godot-${{ hashFiles('**/*.tscn', '**/*.tres', '**/*.gd') }}
          restore-keys: |
            ${{ runner.os }}-godot-

      - name: Run GUT tests
        run: |
          godot --headless --path . -s addons/gut/gut_cmdln.gd -gdir=res://tests/unit,res://tests/integration,res://tests/system -gexit
        continue-on-error: false

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            .gut_editor_config.json
            *.log

  lint:
    name: GDScript Lint
    runs-on: ubuntu-latest
    container:
      image: barichello/godot-ci:4.2.2
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Lint GDScript files
        run: |
          echo "GDScript linting..."
          # Basic syntax check by parsing all .gd files
          # Skip test files that extend GutTest (they need GUT loaded)
          find . -name "*.gd" -not -path "./addons/*" -not -path "./tests/*" | while read file; do
            echo "Checking $file"
            godot --headless --check-only --script "$file" || exit 1
          done
          echo "✅ Linting complete (tests skipped - require GUT context)"

  # Build jobs disabled for Phase 1 - no game content yet
  # Will be enabled in Phase 2 when we have actual scenes to export

  status-report:
    name: Status Report
    needs: [test, lint]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check job statuses
        run: |
          echo "## CI/CD Pipeline Status Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Build jobs disabled for Phase 1 (no game content yet)" >> $GITHUB_STEP_SUMMARY

      - name: Report success
        if: ${{ needs.test.result == 'success' && needs.lint.result == 'success' }}
        run: echo "✅ All Phase 1 jobs completed successfully!"

      - name: Report failure
        if: ${{ needs.test.result != 'success' || needs.lint.result != 'success' }}
        run: |
          echo "❌ One or more jobs failed"
          exit 1
